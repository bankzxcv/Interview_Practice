# 04-health-check.yaml
# Health check every 5 minutes
apiVersion: batch/v1
kind: CronJob
metadata:
  name: health-check
  labels:
    component: monitoring
    type: health-check
spec:
  # Every 5 minutes
  schedule: "*/5 * * * *"

  # Allow concurrent health checks
  concurrencyPolicy: Allow

  # Only keep last 3 successful checks
  successfulJobsHistoryLimit: 3

  # Keep last 5 failed checks for analysis
  failedJobsHistoryLimit: 5

  jobTemplate:
    metadata:
      labels:
        cronjob: health-check
        component: monitoring
    spec:
      # Delete job after 10 minutes
      ttlSecondsAfterFinished: 600

      template:
        metadata:
          labels:
            cronjob: health-check
            component: monitoring
        spec:
          restartPolicy: Never
          containers:
          - name: health-checker
            image: curlimages/curl:8.4.0
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "=== Health Check Started at $(date) ==="

              # Check 1: DNS Resolution
              echo "1. Checking DNS resolution..."
              if nslookup kubernetes.default.svc.cluster.local > /dev/null 2>&1; then
                echo "   ✓ DNS resolution: OK"
              else
                echo "   ✗ DNS resolution: FAILED"
                exit 1
              fi

              # Check 2: Kubernetes API
              echo "2. Checking Kubernetes API..."
              if [ -n "$KUBERNETES_SERVICE_HOST" ]; then
                echo "   ✓ Kubernetes API host: $KUBERNETES_SERVICE_HOST"
              else
                echo "   ✗ Kubernetes API host: NOT FOUND"
              fi

              # Check 3: Simulate endpoint health check
              echo "3. Checking application endpoints..."
              # In real scenario, check actual service endpoints
              # curl -f http://my-service.default.svc.cluster.local/health
              echo "   ✓ Endpoint check: OK (simulated)"

              # Check 4: Resource availability
              echo "4. Checking resource availability..."
              df -h / | tail -1 | awk '{print "   Disk usage: " $5 " used of " $2}'

              # Check 5: Network connectivity
              echo "5. Checking network connectivity..."
              if wget -q --spider --timeout=5 https://www.google.com 2>/dev/null; then
                echo "   ✓ External connectivity: OK"
              else
                echo "   ⚠ External connectivity: LIMITED (expected in kind)"
              fi

              # Summary
              echo ""
              echo "=== Health Check Summary ==="
              echo "Status: HEALTHY"
              echo "Timestamp: $(date)"
              echo "Check ID: $(date +%s)"
              echo "=== Health Check Completed ==="
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
