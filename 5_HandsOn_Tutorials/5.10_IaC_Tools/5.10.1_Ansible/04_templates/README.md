# Ansible Jinja2 Templates

## Overview
Master Jinja2 templating in Ansible for dynamic configuration file generation.

## Prerequisites
- Completed Tutorials 01-03
- Understanding of variables and facts
- Basic template syntax knowledge

## Key Concepts

### Jinja2 Features
- Variable substitution: `{{ variable }}`
- Control structures: `{% if %} {% for %}`
- Filters: `{{ variable | filter }}`
- Comments: `{# comment #}`
- Tests: `{% if variable is defined %}`

## Hands-On Tutorial

### Setup
```bash
mkdir -p ansible-templates/{templates,files} && cd ansible-templates

cat > inventory.ini << 'EOF'
[webservers]
web1 ansible_host=localhost http_port=8081
web2 ansible_host=localhost http_port=8082

[databases]
db1 ansible_host=localhost db_port=5432

[all:vars]
ansible_connection=local
domain=example.com
environment=production
EOF
```

### 1. Basic Template Usage

```bash
# Create a simple template
cat > templates/app-config.j2 << 'EOF'
# Application Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

[application]
name = {{ app_name }}
version = {{ app_version }}
environment = {{ environment }}

[server]
host = {{ server_host | default('0.0.0.0') }}
port = {{ http_port | default(8080) }}
workers = {{ worker_processes | default(4) }}

[database]
host = {{ db_host }}
port = {{ db_port }}
name = {{ db_name }}
user = {{ db_user }}

# System Information
# OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
# Hostname: {{ ansible_hostname }}
EOF

cat > template-basic.yml << 'EOF'
---
- name: Basic Template Usage
  hosts: all
  become: yes

  vars:
    app_name: MyApp
    app_version: "1.0.0"
    server_host: "0.0.0.0"
    db_host: localhost
    db_port: 5432
    db_name: myapp_db
    db_user: appuser

  tasks:
    - name: Create config directory
      file:
        path: /etc/myapp
        state: directory
        mode: '0755'

    - name: Generate config file from template
      template:
        src: templates/app-config.j2
        dest: /etc/myapp/app.conf
        mode: '0644'
        owner: root
        group: root
        backup: yes

    - name: Display generated config
      command: cat /etc/myapp/app.conf
      register: config_content
      changed_when: false

    - name: Show config
      debug:
        var: config_content.stdout_lines
EOF
```

### 2. Conditionals in Templates

```bash
cat > templates/nginx-config.j2 << 'EOF'
# Nginx Configuration
# Managed by Ansible

{% if environment == 'production' %}
user nginx;
worker_processes auto;
{% else %}
user www-data;
worker_processes 2;
{% endif %}

error_log /var/log/nginx/error.log {% if debug_mode %}debug{% else %}warn{% endif %};
pid /var/run/nginx.pid;

events {
    worker_connections {{ worker_connections | default(1024) }};
    {% if use_epoll %}
    use epoll;
    {% endif %}
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    {% if enable_compression %}
    # Compression settings
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript;
    {% endif %}

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Virtual Host
    server {
        listen {{ http_port | default(80) }};
        server_name {{ server_name | default('_') }};

        {% if ssl_enabled %}
        listen 443 ssl http2;
        ssl_certificate {{ ssl_cert_path }};
        ssl_certificate_key {{ ssl_key_path }};
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        {% endif %}

        root {{ document_root | default('/var/www/html') }};
        index index.html index.htm {% if enable_php %}index.php{% endif %};

        location / {
            try_files $uri $uri/ {% if enable_php %}=404{% else %}/index.html{% endif %};
        }

        {% if enable_php %}
        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/var/run/php/php-fpm.sock;
        }
        {% endif %}

        {% if enable_status_page %}
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
        {% endif %}
    }
}
EOF

cat > template-conditionals.yml << 'EOF'
---
- name: Templates with Conditionals
  hosts: webservers
  become: yes

  vars:
    environment: production
    debug_mode: false
    worker_connections: 2048
    use_epoll: true
    enable_compression: true
    http_port: 80
    server_name: "{{ inventory_hostname }}.{{ domain }}"
    ssl_enabled: false
    document_root: /var/www/html
    enable_php: false
    enable_status_page: true

  tasks:
    - name: Generate nginx config
      template:
        src: templates/nginx-config.j2
        dest: /tmp/nginx-{{ inventory_hostname }}.conf
        mode: '0644'
      register: nginx_config

    - name: Display generated nginx config
      debug:
        msg: "{{ lookup('file', nginx_config.dest) }}"
EOF
```

### 3. Loops in Templates

```bash
cat > templates/hosts-file.j2 << 'EOF'
# /etc/hosts
# Managed by Ansible - DO NOT EDIT MANUALLY
# Generated on {{ ansible_date_time.iso8601 }}

127.0.0.1   localhost
::1         localhost ip6-localhost ip6-loopback

# Application servers
{% for host in groups['webservers'] %}
{{ hostvars[host].ansible_host | default(hostvars[host].ansible_default_ipv4.address) }}  {{ host }}.{{ domain }}  {{ host }}
{% endfor %}

# Database servers
{% for host in groups['databases'] %}
{{ hostvars[host].ansible_host | default(hostvars[host].ansible_default_ipv4.address) }}  {{ host }}.{{ domain }}  {{ host }}
{% endfor %}

# Custom entries
{% if custom_hosts is defined %}
{% for entry in custom_hosts %}
{{ entry.ip }}  {{ entry.hostname }}
{% endfor %}
{% endif %}
EOF

cat > templates/service-config.j2 << 'EOF'
# Service Configuration
[services]
{% for service in enabled_services %}
{{ service.name }} = {
    port = {{ service.port }}
    protocol = {{ service.protocol | default('http') }}
    {% if service.ssl_enabled | default(false) %}
    ssl = true
    {% endif %}
    {% if service.replicas is defined %}
    replicas = {{ service.replicas }}
    {% endif %}
}
{% endfor %}

[endpoints]
{% for name, url in api_endpoints.items() %}
{{ name }}_endpoint = {{ url }}
{% endfor %}

[features]
{% for feature, enabled in features.items() if enabled %}
{{ feature }} = enabled
{% endfor %}
EOF

cat > template-loops.yml << 'EOF'
---
- name: Templates with Loops
  hosts: localhost
  connection: local

  vars:
    custom_hosts:
      - { ip: "10.0.1.10", hostname: "cache.example.com" }
      - { ip: "10.0.1.11", hostname: "queue.example.com" }

    enabled_services:
      - { name: "web", port: 8080, protocol: "http", replicas: 3 }
      - { name: "api", port: 8081, protocol: "http", ssl_enabled: true, replicas: 2 }
      - { name: "admin", port: 8082, protocol: "http", ssl_enabled: true }

    api_endpoints:
      users: "https://api.example.com/users"
      orders: "https://api.example.com/orders"
      products: "https://api.example.com/products"

    features:
      authentication: true
      caching: true
      monitoring: true
      debug_mode: false
      experimental: false

  tasks:
    - name: Generate hosts file
      template:
        src: templates/hosts-file.j2
        dest: /tmp/hosts-generated
        mode: '0644'

    - name: Generate service config
      template:
        src: templates/service-config.j2
        dest: /tmp/service-config.conf
        mode: '0644'

    - name: Display hosts file
      debug:
        msg: "{{ lookup('file', '/tmp/hosts-generated') }}"

    - name: Display service config
      debug:
        msg: "{{ lookup('file', '/tmp/service-config.conf') }}"
EOF
```

### 4. Template Filters

```bash
cat > templates/filtered-config.j2 << 'EOF'
# Configuration with Filters
[application]
name = {{ app_name | upper }}
version = {{ app_version }}
description = {{ app_description | default('No description') }}

[paths]
install_dir = {{ install_path | dirname }}
config_file = {{ config_path | basename }}
log_file = {{ log_path | default('/var/log/app.log') }}

[database]
# Password hash: {{ db_password | password_hash('sha512') }}
connection = {{ db_user }}:****@{{ db_host }}:{{ db_port }}/{{ db_name }}
url = {{ database_url | default('postgresql://' + db_host + ':' + db_port|string + '/' + db_name) }}

[server]
allowed_hosts = {{ allowed_hosts | join(', ') }}
ports = {{ service_ports | map('string') | join(', ') }}
max_connections = {{ max_connections | int }}
timeout = {{ timeout_seconds | default(30) | int }}

[metrics]
memory_limit = {{ memory_limit_mb }}MB ({{ (memory_limit_mb / 1024) | round(2) }}GB)
disk_usage = {{ disk_total_gb }}GB total, {{ disk_used_gb }}GB used ({{ ((disk_used_gb / disk_total_gb) * 100) | round(1) }}%)

[timestamps]
deployed_at = {{ ansible_date_time.iso8601 }}
config_date = {{ ansible_date_time.date }}
config_time = {{ ansible_date_time.time }}

[lists]
# Original: {{ packages }}
# Sorted: {{ packages | sort }}
# Unique: {{ packages | unique }}
# Count: {{ packages | length }}

[json]
# Server info as JSON:
{{ server_info | to_nice_json }}

[conditionals]
status = {{ 'active' if is_active else 'inactive' }}
mode = {{ environment | upper if environment in ['production', 'staging'] else 'dev' }}
EOF

cat > template-filters.yml << 'EOF'
---
- name: Template Filters
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    app_name: "myapp"
    app_version: "2.0.0"
    app_description: "Production application"
    install_path: "/opt/myapp/bin/app"
    config_path: "/etc/myapp/config.yml"
    log_path: "/var/log/myapp/app.log"
    db_user: "dbuser"
    db_password: "secretpass"
    db_host: "db.example.com"
    db_port: 5432
    db_name: "production_db"
    allowed_hosts:
      - "example.com"
      - "www.example.com"
      - "api.example.com"
    service_ports: [8080, 8081, 8082]
    max_connections: "100"
    timeout_seconds: 60
    memory_limit_mb: 2048
    disk_total_gb: 500
    disk_used_gb: 350
    packages:
      - nginx
      - postgresql
      - redis
      - nginx
      - python3
    server_info:
      name: "{{ ansible_hostname }}"
      ip: "{{ ansible_default_ipv4.address | default('N/A') }}"
      os: "{{ ansible_distribution }}"
      version: "{{ ansible_distribution_version }}"
    is_active: true
    environment: "production"

  tasks:
    - name: Generate filtered config
      template:
        src: templates/filtered-config.j2
        dest: /tmp/filtered-config.conf
        mode: '0644'

    - name: Display config
      debug:
        msg: "{{ lookup('file', '/tmp/filtered-config.conf') }}"
EOF
```

### 5. Complex Templates

```bash
cat > templates/docker-compose.j2 << 'EOF'
# Docker Compose Configuration
# Environment: {{ environment | upper }}
# Generated: {{ ansible_date_time.iso8601 }}

version: '{{ docker_compose_version | default("3.8") }}'

services:
{% for service in services %}
  {{ service.name }}:
    image: {{ service.image }}{% if service.tag is defined %}:{{ service.tag }}{% endif %}

    {% if service.container_name is defined %}
    container_name: {{ service.container_name }}
    {% endif %}
    {% if service.ports is defined %}
    ports:
    {% for port in service.ports %}
      - "{{ port }}"
    {% endfor %}
    {% endif %}
    {% if service.environment is defined %}
    environment:
    {% for key, value in service.environment.items() %}
      {{ key }}: {{ value }}
    {% endfor %}
    {% endif %}
    {% if service.volumes is defined %}
    volumes:
    {% for volume in service.volumes %}
      - {{ volume }}
    {% endfor %}
    {% endif %}
    {% if service.depends_on is defined %}
    depends_on:
    {% for dep in service.depends_on %}
      - {{ dep }}
    {% endfor %}
    {% endif %}
    {% if service.networks is defined %}
    networks:
    {% for network in service.networks %}
      - {{ network }}
    {% endfor %}
    {% endif %}
    {% if service.restart is defined %}
    restart: {{ service.restart }}
    {% endif %}
    {% if service.healthcheck is defined %}
    healthcheck:
      test: {{ service.healthcheck.test }}
      interval: {{ service.healthcheck.interval | default('30s') }}
      timeout: {{ service.healthcheck.timeout | default('10s') }}
      retries: {{ service.healthcheck.retries | default(3) }}
    {% endif %}

{% endfor %}

{% if networks is defined %}
networks:
{% for network in networks %}
  {{ network.name }}:
    driver: {{ network.driver | default('bridge') }}
    {% if network.ipam is defined %}
    ipam:
      config:
        - subnet: {{ network.ipam.subnet }}
    {% endif %}
{% endfor %}
{% endif %}

{% if volumes is defined %}
volumes:
{% for volume in volumes %}
  {{ volume }}:
{% endfor %}
{% endif %}
EOF

cat > template-complex.yml << 'EOF'
---
- name: Complex Templates
  hosts: localhost
  connection: local

  vars:
    environment: production
    docker_compose_version: "3.8"

    services:
      - name: nginx
        image: nginx
        tag: alpine
        container_name: web-server
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - ./nginx.conf:/etc/nginx/nginx.conf:ro
          - ./html:/usr/share/nginx/html:ro
        networks:
          - frontend
        restart: unless-stopped
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost"]
          interval: 30s
          timeout: 10s
          retries: 3

      - name: app
        image: myapp
        tag: latest
        ports:
          - "8080:8080"
        environment:
          NODE_ENV: production
          DATABASE_URL: postgresql://db:5432/myapp
          REDIS_URL: redis://cache:6379
        volumes:
          - app-data:/app/data
          - ./config:/app/config:ro
        depends_on:
          - db
          - cache
        networks:
          - frontend
          - backend
        restart: always

      - name: db
        image: postgres
        tag: "14-alpine"
        environment:
          POSTGRES_DB: myapp
          POSTGRES_USER: dbuser
          POSTGRES_PASSWORD: dbpass
        volumes:
          - db-data:/var/lib/postgresql/data
        networks:
          - backend
        restart: always

      - name: cache
        image: redis
        tag: alpine
        networks:
          - backend
        restart: always

    networks:
      - name: frontend
        driver: bridge
      - name: backend
        driver: bridge
        ipam:
          subnet: "172.20.0.0/16"

    volumes:
      - app-data
      - db-data

  tasks:
    - name: Generate docker-compose.yml
      template:
        src: templates/docker-compose.j2
        dest: /tmp/docker-compose.yml
        mode: '0644'

    - name: Display docker-compose
      debug:
        msg: "{{ lookup('file', '/tmp/docker-compose.yml') }}"
EOF
```

### 6. Template Validation

```bash
cat > template-validate.yml << 'EOF'
---
- name: Template Validation
  hosts: localhost
  connection: local

  vars:
    config_data:
      server:
        port: 8080
        host: "0.0.0.0"

  tasks:
    - name: Validate template before deployment
      template:
        src: templates/app-config.j2
        dest: /tmp/validated-config.conf
        mode: '0644'
        validate: 'echo %s'  # Replace with actual validation command

    - name: Template with backup
      template:
        src: templates/nginx-config.j2
        dest: /tmp/nginx.conf
        mode: '0644'
        backup: yes

    - name: Template with specific owner/group
      template:
        src: templates/app-config.j2
        dest: /tmp/app-config.conf
        mode: '0644'
        owner: root
        group: root
      become: yes

    - name: Template only if different
      template:
        src: templates/app-config.j2
        dest: /tmp/app-config.conf
        mode: '0644'
        force: no  # Don't overwrite if dest exists
EOF
```

## Verification Steps

```bash
# Run basic templates
ansible-playbook template-basic.yml

# Run conditional templates
ansible-playbook -i inventory.ini template-conditionals.yml

# Run loop templates
ansible-playbook template-loops.yml

# Run filter templates
ansible-playbook template-filters.yml

# Run complex templates
ansible-playbook template-complex.yml

# Verify generated files
cat /tmp/hosts-generated
cat /tmp/service-config.conf
cat /tmp/docker-compose.yml
cat /tmp/filtered-config.conf
```

## Common Template Patterns

### Configuration Files
```jinja2
# Pattern: Environment-specific config
{% if environment == 'production' %}
debug = false
log_level = WARNING
{% else %}
debug = true
log_level = DEBUG
{% endif %}
```

### List Formatting
```jinja2
# Pattern: Format list items
servers = [
{% for server in servers %}
  "{{ server }}"{% if not loop.last %},{% endif %}

{% endfor %}
]
```

### Default Values
```jinja2
# Pattern: Multiple fallbacks
value = {{ custom_value | default(group_value) | default(global_default) }}
```

## Best Practices

1. **Whitespace Control**: Use `{%-` and `-%}` to control whitespace
2. **Comments**: Document complex logic
3. **Validation**: Always validate critical configs
4. **Backups**: Use backup option for important files
5. **Testing**: Test templates in dev before production
6. **Variables**: Keep templates reusable with variables

## Exercise Tasks

1. Create templates for:
   - Nginx virtual host configuration
   - Application configuration with environment-specific settings
   - Docker Compose file for a multi-container application

2. Implement template validation
3. Use filters for data transformation
4. Generate configuration for multiple hosts

## Next Steps

- Tutorial 05: Roles
- Tutorial 06: Ansible Vault
- Tutorial 07: Dynamic Inventory
