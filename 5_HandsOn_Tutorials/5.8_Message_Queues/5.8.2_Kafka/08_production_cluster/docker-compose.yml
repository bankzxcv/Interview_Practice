version: '3.8'

services:
  zk1:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_SERVERS: zk1:2888:3888;zk2:2888:3888;zk3:2888:3888
    volumes: [zk1_data:/var/lib/zookeeper/data, zk1_log:/var/lib/zookeeper/log]
    networks: [kafka-prod]

  zk2:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_SERVER_ID: 2
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_SERVERS: zk1:2888:3888;zk2:2888:3888;zk3:2888:3888
    volumes: [zk2_data:/var/lib/zookeeper/data, zk2_log:/var/lib/zookeeper/log]
    networks: [kafka-prod]

  zk3:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_SERVER_ID: 3
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_SERVERS: zk1:2888:3888;zk2:2888:3888;zk3:2888:3888
    volumes: [zk3_data:/var/lib/zookeeper/data, zk3_log:/var/lib/zookeeper/log]
    networks: [kafka-prod]

  kafka1:
    image: confluentinc/cp-kafka:7.5.0
    depends_on: [zk1, zk2, zk3]
    ports: ["9092:9092"]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zk1:2181,zk2:2181,zk3:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
      KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE: "false"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
    volumes: [kafka1_data:/var/lib/kafka/data]
    networks: [kafka-prod]

  kafka2:
    image: confluentinc/cp-kafka:7.5.0
    depends_on: [zk1, zk2, zk3]
    ports: ["9093:9093"]
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zk1:2181,zk2:2181,zk3:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    volumes: [kafka2_data:/var/lib/kafka/data]
    networks: [kafka-prod]

  kafka3:
    image: confluentinc/cp-kafka:7.5.0
    depends_on: [zk1, zk2, zk3]
    ports: ["9094:9094"]
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zk1:2181,zk2:2181,zk3:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9094
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_MIN_INSYNC_REPLICAS: 2
      KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    volumes: [kafka3_data:/var/lib/kafka/data]
    networks: [kafka-prod]

  prometheus:
    image: prom/prometheus
    ports: ["9090:9090"]
    volumes: [./prometheus.yml:/etc/prometheus/prometheus.yml]
    networks: [kafka-prod]

  grafana:
    image: grafana/grafana
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    networks: [kafka-prod]

volumes:
  zk1_data:
  zk1_log:
  zk2_data:
  zk2_log:
  zk3_data:
  zk3_log:
  kafka1_data:
  kafka2_data:
  kafka3_data:

networks:
  kafka-prod:
